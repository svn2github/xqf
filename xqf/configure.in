#
# Autoconf support for XQF
# Initially written by Markus Fischer <mfischer@josefine.ben.tuwien.ac.at>
#

AC_INIT(src/xqf.c)

AM_INIT_AUTOMAKE(xqf, 0.9.7c)
dnl AM_CONFIG_HEADER(src/gnuconfig.h:src/gnuconfig.h.in)
AM_CONFIG_HEADER(src/gnuconfig.h)

ALL_LINGUAS="de es"

dnl Checks for programs.
AC_PROG_CC
AC_ISC_POSIX

dnl Checks for header files.
AC_HEADER_STDC

AM_SANITY_CHECK

AM_PROG_LIBTOOL

dnl Pick up the gettext, etc macros
dnl AM_ACLOCAL_INCLUDE(macros)
AM_GNU_GETTEXT

AM_PATH_GTK(1.2.0,,exit 1)

dnl check for qstat
AC_ARG_WITH(qstat,[  --with-qstat=CMD        use CMD to run qstat])

AC_MSG_CHECKING(qstat version)

QSTATEXEC="qstat"

if test "x$with_qstat" != "x" ; then
	QSTATEXEC="$with_qstat"
fi

qstat_version=`$QSTATEXEC 2>/dev/null | grep version | cut -d' ' -f 3`

if test "x$qstat_version" = "x" ; then
	AC_MSG_RESULT(qstat not found)
	qstat_is=notfound
else
	AC_MSG_RESULT($qstat_version)
fi

AC_SUBST(QSTATEXEC)

case "$qstat_version" in
	2.0*|2.1*|2.3*|2.4a|2.4b|2.4c|2.4d)
	qstat_is=tooold
	;;
esac

QSTAT23="-DQSTAT23 -DQSTAT_HAS_UNREAL_SUPPORT"

AC_SUBST(QSTAT23)

dnl check if user wants bzip2 compression instead of gzip
COMPRESSION="-DCOMPRESSOR_GZIP"
AC_ARG_ENABLE(bzip2,[  --enable-bzip2          use bzip2 for data compression],COMPRESSION="-DCOMPRESSOR_BZIP2")
AC_SUBST(COMPRESSION)

dnl check if user wants debug
AC_ARG_ENABLE(debug,[  --enable-debug          turn on debugging ],DEBUG="-g -DDEBUG", DEBUG="")
AC_SUBST(DEBUG)

AC_SUBST(VERSION)
AC_SUBST(QSTATEXEC)

AC_DEFINE_UNQUOTED(XQF_VERSION, "$VERSION", XQF Version number)
AC_DEFINE_UNQUOTED(QSTAT_EXEC, "$QSTATEXEC", QSTAT executable path)

# workaround for intl/ which requires config.h
echo "creating link config.h -> src/gnuconfig.h"
test -e config.h -a ! -L config.h && rm config.h
test ! -e config.h && ln -s src/gnuconfig.h config.h

rm -f intl/libintl.h
# damn gettext should do that itself!
if test "$USE_INCLUDED_LIBINTL" = "yes"; then
	echo "creating link intl/libintl.h -> libgnuintl.h"
	ln -s libgnuintl.h intl/libintl.h
fi

if test "x$GCC" = xyes; then
	CFLAGS="$CFLAGS -Wall"
fi

AC_OUTPUT([Makefile intl/Makefile po/Makefile.in \
src/Makefile src/xpm/Makefile \
docs/Makefile \
debian/Makefile])

if test "x$qstat_is" = "xnotfound" ; then
	AC_MSG_RESULT([
*** QStat is *required* to run XQF
*** Get it from http://qstat.org/
*** and put it in your path
])
elif test "x$qstat_is" = "xtooold" ; then
	AC_MSG_RESULT([
*** You have an old QStat version installed
*** QStat 2.4e is recommended to run XQF
*** Get it from http://qstat.org/
])
fi
